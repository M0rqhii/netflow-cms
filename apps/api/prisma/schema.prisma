// Prisma Schema - Multi-Tenant Headless CMS
// AI Note: Zawsze dodawaj tenantId do każdego modelu dla izolacji danych

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Tenant model - organizacje korzystające z platformy
model Tenant {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique
  plan      String   @default("free") // free, professional, enterprise
  settings  Json     @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users             User[]
  contentTypes      ContentType[]
  contentEntries    ContentEntry[]
  collections       Collection[]
  collectionItems   CollectionItem[]
  collectionItemVersions CollectionItemVersion[]
  mediaFiles        MediaItem[]
  memberships       UserTenant[]
  contentReviews    ContentReview[]
  contentComments   ContentComment[]
  tasks             Task[]
  collectionRoles   CollectionRole[]
  webhooks          Webhook[]
  webhookDeliveries WebhookDelivery[]
  hooks             Hook[]
  subscriptions     Subscription[]
  invoices          Invoice[]
  payments          Payment[]
  usageTracking     UsageTracking[]
  seoSettings       SeoSettings?
  siteEnvironments  SiteEnvironment[]
  pages             Page[]
  featureOverrides  SiteFeatureOverride[]
  deployments       SiteDeployment[]
  snapshots         SiteSnapshot[]
  siteEvents        SiteEvent[]
  roles             Role[]
  userRoles         UserRole[]
  orgPolicies      OrgPolicy[]
  campaigns         Campaign[]
  distributionDrafts DistributionDraft[]
  channelConnections ChannelConnection[]
  publishJobs       PublishJob[]
  publishResults    PublishResult[]

  @@map("tenants")
}

// User model - użytkownicy w systemie
model User {
  id                String   @id @default(uuid())
  tenantId          String
  email             String
  passwordHash      String
  role              String   @default("viewer") // Backward compatibility: super_admin, tenant_admin, editor, viewer
  siteRole          String   @default("viewer") // viewer, editor, editor-in-chief, marketing, admin, owner
  platformRole      String?  // user, editor-in-chief, admin, owner (nullable)
  systemRole        String?  // super_admin, system_admin, system_dev, system_support (nullable)
  isSuperAdmin      Boolean  @default(false) // Flaga dla super admin
  preferredLanguage String   @default("en") // pl, en
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Optional memberships table to enable multi-tenant users (forward-compatible)
  memberships UserTenant[]

  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([isSuperAdmin])
  @@index([systemRole])
  @@index([siteRole])
  @@index([platformRole])
  @@map("users")
}

// ContentType model - definicje typów treści
model ContentType {
  id        String   @id @default(uuid())
  tenantId  String
  name      String
  slug      String
  schema    Json // Zod schema jako JSON
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant         Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  contentEntries ContentEntry[]

  @@unique([tenantId, slug])
  @@index([tenantId])
  @@map("content_types")
}

// ContentEntry model - wpisy treści
model ContentEntry {
  id            String    @id @default(uuid())
  tenantId      String
  contentTypeId String
  data          Json // Dane treści zgodne ze schematem ContentType
  status        String    @default("draft") // draft, review, published, archived
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  publishedAt   DateTime? // Data publikacji
  reviewedAt    DateTime? // Data ostatniej recenzji
  reviewedById  String? // ID użytkownika który zatwierdził
  createdById   String? // ID użytkownika który utworzył
  updatedById   String? // ID użytkownika który ostatnio zaktualizował

  tenant      Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  contentType ContentType      @relation(fields: [contentTypeId], references: [id], onDelete: Cascade)
  reviews     ContentReview[]
  comments    ContentComment[]
  tasks       Task[]

  @@index([tenantId])
  @@index([tenantId, contentTypeId])
  @@index([tenantId, status])
  @@index([tenantId, createdAt])
  @@index([tenantId, publishedAt])
  @@map("content_entries")
}

// Collection model - kolekcje treści (rozszerzenie ContentType z wersjonowaniem)
model Collection {
  id         String   @id @default(uuid())
  tenantId   String
  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  slug       String
  name       String
  schemaJson Json // Zod schema jako JSON
  workflowConfig Json? // Konfiguracja workflow per kolekcja: { stages: ['draft', 'review', 'approved', 'published', 'archived'], requireReview: boolean, autoTasks: {...} }
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  items        CollectionItem[]
  roles        CollectionRole[]
  webhooks     Webhook[]
  hooks        Hook[]

  @@unique([tenantId, slug])
  @@index([tenantId])
  @@map("collections")
}

// CollectionItem model - elementy kolekcji z wersjonowaniem
model CollectionItem {
  id           String     @id @default(uuid())
  tenantId     String
  tenant       Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  collectionId String
  collection   Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  status       ItemStatus @default(DRAFT)
  data         Json // Walidowane względem Collection.schemaJson
  createdById  String?
  updatedById  String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  version      Int        @default(1)
  publishedAt  DateTime?
  etag         String     @default("")

  versions     CollectionItemVersion[]

  @@index([tenantId, collectionId])
  @@index([tenantId, status])
  @@index([tenantId, createdAt])
  @@index([collectionId, status])
  @@map("collection_items")
}

// CollectionItemVersion model - historia wersji elementów kolekcji
model CollectionItemVersion {
  id           String         @id @default(uuid())
  tenantId     String
  tenant       Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  itemId       String
  item         CollectionItem @relation(fields: [itemId], references: [id], onDelete: Cascade)
  version      Int // Numer wersji (1, 2, 3...)
  data         Json // Snapshot danych wersji
  status       ItemStatus // Status wersji
  changeNote   String? // Opcjonalna notatka o zmianach
  changedBy    String? // ID użytkownika który wprowadził zmianę
  createdAt    DateTime       @default(now())

  @@index([tenantId, itemId])
  @@index([tenantId, itemId, version])
  @@index([tenantId, createdAt])
  @@map("collection_item_versions")
}

enum ItemStatus {
  DRAFT
  REVIEW
  APPROVED
  PUBLISHED
  ARCHIVED
}

// Plan enum - plany subskrypcyjne
enum Plan {
  BASIC
  PRO
}

// MediaItem model - stored media assets per site
model MediaItem {
  id           String   @id @default(cuid())
  siteId       String   @map("tenantId")
  tenant       Tenant   @relation(fields: [siteId], references: [id], onDelete: Cascade)
  fileName     String   @map("filename")
  path         String
  url          String
  mimeType     String
  size         Int
  width        Int?
  height       Int?
  alt          String?
  metadata     Json     @default("{}")
  uploadedById String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([siteId])
  @@index([siteId, mimeType])
  @@index([siteId, createdAt])
  @@map("media_files")
}

// UserTenant join table — forward-compatible multi-tenant membership
model UserTenant {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  tenantId  String   @map("tenant_id")
  role      String   @default("viewer")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([userId, tenantId])
  @@index([tenantId])
  @@index([userId])
  @@map("user_tenants")
}

// ContentReview model - historia recenzji i akceptacji treści
model ContentReview {
  id             String   @id @default(uuid())
  contentEntryId String
  tenantId       String
  reviewerId     String // ID użytkownika który recenzuje
  status         String // approved, rejected, changes_requested
  comment        String? // Komentarz recenzenta
  createdAt      DateTime @default(now())

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  contentEntry ContentEntry @relation(fields: [contentEntryId], references: [id], onDelete: Cascade)

  @@index([contentEntryId])
  @@index([tenantId])
  @@index([reviewerId])
  @@index([createdAt])
  @@map("content_reviews")
}

// ContentComment model - komentarze do treści w procesie recenzji
model ContentComment {
  id             String   @id @default(uuid())
  contentEntryId String
  tenantId       String
  authorId       String // ID użytkownika który dodał komentarz
  content        String // Treść komentarza
  resolved       Boolean  @default(false) // Czy komentarz został rozwiązany
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  contentEntry ContentEntry @relation(fields: [contentEntryId], references: [id], onDelete: Cascade)

  @@index([contentEntryId])
  @@index([tenantId])
  @@index([authorId])
  @@index([createdAt])
  @@map("content_comments")
}

// Task model - zadania w workflow (tasks)
model Task {
  id            String   @id @default(uuid())
  tenantId       String
  contentEntryId String? // Opcjonalne powiązanie z content entry
  collectionItemId String? // Opcjonalne powiązanie z collection item
  title          String
  description    String?
  status         TaskStatus @default(PENDING) // pending, in_progress, completed, cancelled
  priority       TaskPriority @default(MEDIUM) // low, medium, high, urgent
  assignedToId   String? // ID użytkownika przypisanego do zadania
  createdById    String // ID użytkownika który utworzył zadanie
  dueDate        DateTime? // Termin wykonania
  completedAt    DateTime?
  createdAt      DateTime @default(now())
  updatedAt       DateTime @updatedAt

  tenant       Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  contentEntry ContentEntry? @relation(fields: [contentEntryId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, assignedToId])
  @@index([contentEntryId])
  @@index([collectionItemId])
  @@map("tasks")
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

// CollectionRole model - role per kolekcja z granularnymi uprawnieniami (rozszerzenie RBAC)
model CollectionRole {
  id           String   @id @default(uuid())
  tenantId     String
  collectionId String
  userId       String
  role         String   @default("viewer") // viewer, editor, admin (backward compatibility)
  // Granularne uprawnienia per kolekcja
  canRead      Boolean  @default(true) // Może czytać elementy kolekcji
  canWrite     Boolean  @default(false) // Może tworzyć/edytować elementy
  canPublish   Boolean  @default(false) // Może publikować elementy
  canDelete    Boolean  @default(false) // Może usuwać elementy
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tenant     Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  collection Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)

  @@unique([collectionId, userId])
  @@index([tenantId])
  @@index([collectionId])
  @@index([userId])
  @@map("collection_roles")
}

// Webhook model - konfiguracja webhooków per tenant/kolekcja
model Webhook {
  id          String   @id @default(uuid())
  tenantId    String
  collectionId String? // Opcjonalne - jeśli null, webhook jest globalny dla tenant
  url         String // URL do którego wysyłane są webhooki
  events      String[] // Lista eventów (content.created, content.updated, etc.)
  secret      String // Secret do podpisywania HMAC
  active      Boolean  @default(true)
  description String?
  retryCount  Int      @default(3) // Liczba prób retry
  timeout     Int      @default(5000) // Timeout w ms
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant     Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  collection Collection?        @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  deliveries WebhookDelivery[]

  @@index([tenantId])
  @@index([collectionId])
  @@index([active])
  @@map("webhooks")
}

// Hook model - konfigurowalne hooki per tenant/collection (rozszerzalność)
model Hook {
  id           String   @id @default(uuid())
  tenantId     String
  collectionId String? // Opcjonalne - jeśli null, hook jest globalny dla tenant
  name         String // Nazwa hooka (np. "beforeCreate", "afterPublish")
  type         String // Typ hooka: "before" | "after" | "transform"
  event        String // Event który wyzwala hook (np. "item.create", "item.publish")
  handler      String // Handler hooka (URL, function name, etc.)
  config       Json    @default("{}") // Konfiguracja hooka
  active       Boolean @default(true)
  priority     Int     @default(0) // Priorytet wykonania (niższy = wcześniej)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tenant     Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  collection Collection? @relation(fields: [collectionId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([collectionId])
  @@index([active])
  @@index([event])
  @@map("hooks")
}

// WebhookDelivery model - logi dostarczenia webhooków
model WebhookDelivery {
  id          String    @id @default(uuid())
  webhookId   String
  tenantId    String
  event       String // Nazwa eventu
  status      String // success, failed, pending
  statusCode  Int? // HTTP status code
  response    String? // Response body
  error       String? // Error message
  attempt     Int       @default(1) // Numer próby
  deliveredAt DateTime?
  createdAt   DateTime  @default(now())

  webhook Webhook @relation(fields: [webhookId], references: [id], onDelete: Cascade)
  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([webhookId])
  @@index([tenantId])
  @@index([status])
  @@index([createdAt])
  @@map("webhook_deliveries")
}

// Subscription model - subskrypcje planów dla tenantów (SiteSubscription)
// renewalDate = currentPeriodEnd (mapowane w API)
model Subscription {
  id                  String    @id @default(uuid())
  tenantId            String    // siteId - ID tenant/site
  tenant              Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  plan                String     @default("BASIC") // BASIC, PRO (używa Plan enum wartości jako string)
  status              String     @default("active") // active, cancelled, past_due, trialing
  currentPeriodStart  DateTime
  currentPeriodEnd    DateTime   // renewalDate (mapowane w API)
  cancelAtPeriodEnd   Boolean   @default(false)
  cancelledAt         DateTime?
  trialStart          DateTime?
  trialEnd            DateTime?
  stripeSubscriptionId String?  @unique
  stripeCustomerId    String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  invoices Invoice[]

  @@index([tenantId])
  @@index([status])
  @@index([plan])
  @@index([stripeSubscriptionId])
  @@index([stripeCustomerId])
  @@map("subscriptions")
}

// Invoice model - faktury dla subskrypcji
model Invoice {
  id              String    @id @default(uuid())
  tenantId        String
  tenant          Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  subscriptionId  String?
  subscription    Subscription? @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)
  amount          Decimal   @db.Decimal(10, 2)
  currency        String    @default("USD") @db.Char(3)
  status          String    @default("draft") // draft, open, paid, void, uncollectible
  dueDate         DateTime?
  paidAt          DateTime?
  stripeInvoiceId String?   @unique
  invoiceNumber   String    @unique
  lineItems       Json      @default("[]")
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  payments Payment[]

  @@index([tenantId])
  @@index([subscriptionId])
  @@index([status])
  @@index([invoiceNumber])
  @@index([stripeInvoiceId])
  @@map("invoices")
}

// Payment model - płatności za faktury
model Payment {
  id                  String    @id @default(uuid())
  tenantId            String
  tenant              Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  invoiceId           String?
  invoice             Invoice?   @relation(fields: [invoiceId], references: [id], onDelete: SetNull)
  amount              Decimal   @db.Decimal(10, 2)
  currency            String    @default("USD") @db.Char(3)
  status              String    @default("pending") // pending, succeeded, failed, refunded
  paymentMethod      String
  stripePaymentIntentId String? @unique
  paidAt              DateTime?
  metadata            Json      @default("{}")
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@index([tenantId])
  @@index([invoiceId])
  @@index([status])
  @@index([stripePaymentIntentId])
  @@map("payments")
}

// UsageTracking model - śledzenie użycia zasobów per tenant/period
model UsageTracking {
  id           String   @id @default(uuid())
  tenantId     String
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  resourceType String // collections, contentTypes, mediaFiles, users, storageMB, apiRequests
  count        Int      @default(0)
  period       String   @db.Char(7) // Format: YYYY-MM
  metadata     Json     @default("{}")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([tenantId, resourceType, period])
  @@index([tenantId])
  @@index([tenantId, period])
  @@index([resourceType])
  @@map("usage_tracking")
}

// DevEmailLog model - development email logging for observability
model DevEmailLog {
  id        String   @id @default(uuid())
  to        String
  subject   String
  body      String   @db.Text
  from      String?
  replyTo   String?
  cc        String?
  bcc       String?
  variables Json     @default("{}")
  metadata  Json     @default("{}")
  status    String   @default("sent") // sent, failed, pending
  sentAt    DateTime @default(now())
  createdAt DateTime @default(now())

  @@index([to])
  @@index([status])
  @@index([sentAt])
  @@map("dev_email_log")
}

// DevDomainRecord model - development domain configuration logging
model DevDomainRecord {
  id        String   @id @default(uuid())
  domain    String
  tenantId  String
  targetUrl String?
  status    String   @default("configured") // configured, pending, failed
  sslStatus String   @default("active") // active, pending, failed
  metadata  Json     @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([domain, tenantId])
  @@index([tenantId])
  @@index([domain])
  @@index([status])
  @@map("dev_domain_records")
}

// SEO settings per site (skeleton)
model SeoSettings {
  id            String   @id @default(uuid())
  tenantId      String
  title         String?
  description   String?
  ogTitle       String?
  ogDescription String?
  ogImage       String?
  twitterCard   String?  @default("summary_large_image")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId])
  @@index([tenantId])
  @@map("seo_settings")
}

// Site environments - per-tenant deployment environments (draft, production, etc.)
model SiteEnvironment {
  id        String           @id @default(uuid())
  tenantId  String
  type      EnvironmentType
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  pages  Page[]

  @@unique([tenantId, type])
  @@index([tenantId])
  @@map("site_environments")
}

// Pages - per-environment site pages for Site Panel
model Page {
  id            String       @id @default(uuid())
  tenantId      String
  environmentId String
  slug          String
  title         String
  status        PageStatus   @default(DRAFT)
  content       Json         @default("{}")
  publishedAt   DateTime?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  tenant       Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  environment  SiteEnvironment @relation(fields: [environmentId], references: [id], onDelete: Cascade)

  @@unique([tenantId, environmentId, slug], name: "tenant_env_slug")
  @@index([tenantId, environmentId])
  @@index([tenantId, status])
  @@index([tenantId, slug])
  @@map("pages")
}

enum EnvironmentType {
  DRAFT
  PRODUCTION
}

enum PageStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

// SiteFeatureOverride model - per-site feature overrides
model SiteFeatureOverride {
  id        String   @id @default(cuid())
  siteId    String
  featureKey String
  enabled   Boolean
  createdAt DateTime @default(now())

  tenant Tenant @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@unique([siteId, featureKey])
  @@index([siteId])
  @@index([featureKey])
  @@map("site_feature_overrides")
}

// Site-level snapshots (backups)
model SiteSnapshot {
  id        String   @id @default(cuid())
  siteId    String
  label     String
  data      Json
  createdAt DateTime @default(now())

  tenant Tenant @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@index([siteId])
  @@map("site_snapshots")
}

// Site-level events (activity log)
model SiteEvent {
  id        String   @id @default(cuid())
  siteId    String
  userId    String?
  type      String
  message   String
  metadata  Json?
  createdAt DateTime @default(now())

  tenant Tenant @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@index([siteId, createdAt])
  @@map("site_events")
}

// Site deployments - log of publish/deploy operations
model SiteDeployment {
  id        String   @id @default(cuid())
  siteId    String
  env       String   // e.g. 'production'
  type      String   // e.g. 'publish'
  status    String   // 'success' | 'failed'
  message   String?
  createdAt DateTime @default(now())

  tenant Tenant @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@index([siteId, createdAt])
  @@index([siteId, env])
  @@map("site_deployments")
}

// ============================================
// RBAC Models - Role-Based Access Control
// ============================================

// Capability model - atomowe uprawnienia (jedyna prawda o uprawnieniach)
model Capability {
  id          String   @id @default(uuid())
  key         String   @unique // e.g. "builder.publish", "org.users.invite"
  module      String   // e.g. "builder", "org", "billing"
  label       String   // Human-readable label
  description String?  // Opis capability
  riskLevel   String   @default("LOW") // LOW, MED, HIGH
  isDangerous Boolean  @default(false) // Czy capability jest niebezpieczne
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  roleCapabilities RoleCapability[]

  @@index([module])
  @@index([key])
  @@map("capabilities")
}

// Role model - role systemowe (preset, immutable) i custom (edytowalne)
model Role {
  id          String   @id @default(uuid())
  orgId        String    // tenantId - organizacja do której należy rola
  name        String   // e.g. "Org Owner", "Site Admin", "Custom Role 1"
  description String?  // Opis roli
  type        String   // SYSTEM | CUSTOM
  scope       String   // ORG | SITE
  isImmutable Boolean  @default(false) // Systemowe role są immutable
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant          Tenant          @relation(fields: [orgId], references: [id], onDelete: Cascade)
  roleCapabilities RoleCapability[]
  userRoles       UserRole[]

  @@unique([orgId, name, scope])
  @@index([orgId])
  @@index([orgId, scope])
  @@index([type])
  @@map("roles")
}

// RoleCapability join table - przypisanie capabilities do ról
model RoleCapability {
  id          String   @id @default(uuid())
  roleId      String
  capabilityId String
  createdAt   DateTime @default(now())

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  capability Capability @relation(fields: [capabilityId], references: [id], onDelete: Cascade)

  @@unique([roleId, capabilityId])
  @@index([roleId])
  @@index([capabilityId])
  @@map("role_capabilities")
}

// UserRole model - przypisanie ról do użytkowników (scope ORG lub SITE)
model UserRole {
  id        String   @id @default(uuid())
  orgId     String   // tenantId - organizacja
  userId    String   // ID użytkownika
  roleId    String   // ID roli
  siteId    String?  // nullable - jeśli null, to rola ORG scope; jeśli ustawione, to SITE scope
  createdAt DateTime @default(now())

  tenant Tenant @relation(fields: [orgId], references: [id], onDelete: Cascade)
  role   Role   @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@index([orgId, userId])
  @@index([orgId, siteId])
  @@index([roleId])
  @@index([userId])
  @@index([siteId])
  @@map("user_roles")
}

// OrgPolicy model - globalne włączanie/wyłączanie capabilities w organizacji (⚠️ policy toggle)
model OrgPolicy {
  id             String   @id @default(uuid())
  orgId          String   // tenantId - organizacja
  capabilityKey  String   // Klucz capability (np. "builder.rollback")
  enabled        Boolean  @default(true) // Czy capability jest włączone w organizacji
  createdByUserId String? // ID użytkownika który ustawił policy
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant Tenant @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId, capabilityKey])
  @@index([orgId])
  @@index([capabilityKey])
  @@map("org_policies")
}

// AuditLog model - minimalny model do logowania zmian RBAC
model AuditLog {
  id         String   @id @default(uuid())
  entityType String   // "role", "capability", "user_role", "org_policy"
  entityId   String   // ID encji która została zmieniona
  action     String   // "create", "update", "delete", "assign", "revoke"
  actorUserId String? // ID użytkownika który wykonał akcję
  orgId      String?  // tenantId - organizacja (opcjonalne)
  siteId     String?  // ID strony (opcjonalne)
  metadata   Json     @default("{}") // Dodatkowe metadane
  createdAt  DateTime @default(now())

  @@index([entityType, entityId])
  @@index([actorUserId])
  @@index([orgId])
  @@index([siteId])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============================================
// Marketing & Distribution Models
// ============================================

// Campaign model - kampanie marketingowe
model Campaign {
  id          String   @id @default(uuid())
  orgId       String   // tenantId - organizacja
  siteId      String   // ID strony
  name        String   // Nazwa kampanii
  description String?  // Opis kampanii
  status      String   @default("draft") // draft, active, paused, completed, archived
  startDate   DateTime? // Data rozpoczęcia
  endDate     DateTime? // Data zakończenia
  createdById String?  // ID użytkownika który utworzył
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant           Tenant            @relation(fields: [orgId], references: [id], onDelete: Cascade)
  distributionDrafts DistributionDraft[]
  publishJobs      PublishJob[]

  @@index([orgId, siteId])
  @@index([orgId, status])
  @@index([siteId])
  @@index([createdAt])
  @@map("marketing_campaigns")
}

// DistributionDraft model - wersje postów do publikacji (draft)
model DistributionDraft {
  id          String   @id @default(uuid())
  orgId       String   // tenantId - organizacja
  siteId      String   // ID strony
  campaignId  String?  // Opcjonalne powiązanie z kampanią
  contentId   String?  // ID treści z CMS (opcjonalne)
  title       String   // Tytuł posta
  content     Json     // Treść posta (JSON - może zawierać różne wersje dla różnych kanałów)
  channels    String[] // Lista kanałów: ["site", "facebook", "twitter", "linkedin", "instagram", "ads"]
  status      String   @default("draft") // draft, ready, published, archived
  scheduledAt DateTime? // Zaplanowana data publikacji
  createdById String?  // ID użytkownika który utworzył
  createdAt   DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tenant      Tenant       @relation(fields: [orgId], references: [id], onDelete: Cascade)
  campaign    Campaign?    @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  publishJobs PublishJob[]

  @@index([orgId, siteId])
  @@index([orgId, status])
  @@index([campaignId])
  @@index([siteId])
  @@index([createdAt])
  @@map("marketing_distribution_drafts")
}

// ChannelConnection model - połączenia z kanałami social media (stub)
model ChannelConnection {
  id          String   @id @default(uuid())
  orgId       String   // tenantId - organizacja
  siteId      String   // ID strony
  channel     String   // facebook, twitter, linkedin, instagram, ads
  channelId   String?  // ID konta w kanale (np. Facebook Page ID)
  channelName String?  // Nazwa konta w kanale
  status      String   @default("connected") // connected, disconnected, error
  credentials Json     @default("{}") // Encrypted credentials (stub - w produkcji użyj vault)
  metadata    Json     @default("{}") // Dodatkowe metadane
  connectedById String? // ID użytkownika który połączył
  connectedAt   DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tenant Tenant @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId, siteId, channel])
  @@index([orgId, siteId])
  @@index([channel])
  @@index([status])
  @@map("marketing_channel_connections")
}

// PublishJob model - joby publikacji (zapis stanu publikacji)
model PublishJob {
  id              String   @id @default(uuid())
  orgId           String   // tenantId - organizacja
  siteId          String   // ID strony
  campaignId      String?  // Opcjonalne powiązanie z kampanią
  draftId         String?  // Opcjonalne powiązanie z draftem
  channels        String[] // Lista kanałów do publikacji: ["site", "facebook", "twitter", "ads"]
  status          String   @default("pending") // pending, processing, success, failed, cancelled
  startedAt       DateTime?
  completedAt     DateTime?
  createdById     String?  // ID użytkownika który utworzył job
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  tenant          Tenant           @relation(fields: [orgId], references: [id], onDelete: Cascade)
  campaign        Campaign?        @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  draft           DistributionDraft? @relation(fields: [draftId], references: [id], onDelete: SetNull)
  publishResults  PublishResult[]

  @@index([orgId, siteId])
  @@index([orgId, status])
  @@index([campaignId])
  @@index([draftId])
  @@index([siteId])
  @@index([createdAt])
  @@map("marketing_publish_jobs")
}

// PublishResult model - wyniki publikacji per kanał
model PublishResult {
  id          String   @id @default(uuid())
  jobId       String   // ID joba publikacji
  orgId       String   // tenantId - organizacja
  siteId      String   // ID strony
  channel     String   // site, facebook, twitter, linkedin, instagram, ads
  status      String   // success, failed, skipped
  externalId  String?  // ID posta w zewnętrznym systemie (np. Facebook Post ID)
  url         String?  // URL opublikowanego posta
  error       String?  // Komunikat błędu (jeśli status = failed)
  publishedAt DateTime? // Data publikacji
  metadata    Json     @default("{}") // Dodatkowe metadane
  createdAt   DateTime @default(now())

  tenant Tenant      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  job    PublishJob  @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([jobId])
  @@index([orgId, siteId])
  @@index([channel])
  @@index([status])
  @@index([createdAt])
  @@map("marketing_publish_results")
}
